/*
 * ORAQUADRA NANO - ESP32C3 VOICE ASSISTANT
 * Gestione microfono INMP441 e Speech-to-Text
 *
 * Hardware:
 * - Microfono INMP441 I2S
 *   SCK (BCLK): GPIO 4 (condiviso con speaker)
 *   WS (LRC):   GPIO 5 (condiviso con speaker)
 *   SD (DIN):   GPIO 3 (nuovo pin per input dal microfono)
 *   L/R:        GND (mono, canale sinistro)
 *   VDD:        3.3V
 *   GND:        GND
 *
 * NOTA IMPORTANTE:
 * ESP32C3 ha solo UN controller I2S (I2S_NUM_0), quindi:
 * - Quando registra: I2S configurato in modalità RX (microfono)
 * - Quando riproduce: I2S configurato in modalità TX (speaker)
 * Non possono funzionare contemporaneamente!
 *
 * By Paolo Sambinello - 2025
 */

#ifndef VOICE_ASSISTANT_H
#define VOICE_ASSISTANT_H

#include <Arduino.h>
#include <driver/i2s.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>
#include <base64.h>

// ================== CONFIGURAZIONE PIN I2S MICROFONO ==================
#define I2S_MIC_SCK_PIN       4     // Clock (condiviso con speaker)
#define I2S_MIC_WS_PIN        5     // Word Select (condiviso con speaker)
#define I2S_MIC_SD_PIN        3     // Serial Data IN (solo per microfono)
#define I2S_MIC_PORT          I2S_NUM_0
#define I2S_MIC_SAMPLE_RATE   16000
#define I2S_MIC_BUFFER_SIZE   1024

// ================== CONFIGURAZIONE VOICE RECORDING ==================
#define VOICE_MAX_RECORDING_TIME  5000  // 5 secondi max
#define VOICE_BUFFER_SIZE         (I2S_MIC_SAMPLE_RATE * 2 * 5)  // 5 sec, 16bit mono = 160KB

// ================== CONFIGURAZIONE GOOGLE CLOUD STT ==================
// Usa la stessa API key di Gemini (dalla secret.h)
// NOTA: GEMINI_API_KEY è una macro #define in secret.h, non serve extern

// ================== RIFERIMENTI GLOBALI AUDIO ==================
class AudioOutputI2S;
extern AudioOutputI2S *output;  // Puntatore globale all'output I2S (definito in .ino)
extern bool isPlaying;          // Flag riproduzione in corso (definito in .ino)

// Funzioni audio principali (definite in .ino)
extern void cleanupAudio(bool destroyOutput = true);
extern void setupAudio();

// ================== VARIABILI GLOBALI VOICE ==================
extern bool voiceMicInitialized;
extern bool voiceListening;
extern uint8_t* voiceAudioBuffer;
extern size_t voiceAudioBufferPos;
extern unsigned long voiceRecordingStartTime;

// ================== PROTOTIPI FUNZIONI ==================

/**
 * Inizializza il microfono INMP441 I2S
 * NOTA: Disinstalla temporaneamente l'audio output!
 * Chiamare restoreAudioOutput() dopo aver finito con il microfono
 */
bool setupVoiceMicrophone();

/**
 * Ripristina l'audio output dopo aver usato il microfono
 * Chiama setupAudio() per ri-configurare l'output
 */
void restoreAudioOutput();

/**
 * Inizia la registrazione dal microfono
 * Ritorna true se la registrazione è iniziata con successo
 */
bool voiceStartRecording();

/**
 * Ferma la registrazione e ritorna la dimensione in bytes
 */
size_t voiceStopRecording();

/**
 * Cattura campioni audio dal microfono (chiamare in loop quando voiceListening = true)
 * Converte da 32bit a 16bit e salva nel buffer
 */
void voiceCaptureAudio();

/**
 * Converte audio registrato in testo usando Google Cloud Speech-to-Text
 * @param audioData Buffer con audio PCM 16bit, 16kHz, mono
 * @param audioSize Dimensione del buffer in bytes
 * @return Testo trascritto (vuoto se errore)
 */
String voiceSpeechToText(uint8_t* audioData, size_t audioSize);

/**
 * Pipeline completa: STT → Gemini AI → TTS
 * Chiamare dopo voiceStopRecording()
 *
 * Sequenza:
 * 1. Converte audio in testo (Google STT)
 * 2. Invia domanda a Gemini AI (già implementato in askGeminiAndSpeak)
 * 3. Gemini risponde e parla (TTS automatico)
 */
void voiceProcessQuestion();

/**
 * Pulisce le risorse allocate per il voice
 */
void voiceCleanup();

#endif // VOICE_ASSISTANT_H
